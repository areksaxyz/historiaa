<!DOCTYPE html>
<html lang="id"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security6">
<head>
  <meta charset="UTF-8">
  <title>Lapor Situs Baru</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc }
    .wrapper { max-width:860px }
    .card { border:none; border-radius:14px; box-shadow:0 10px 28px rgba(0,0,0,.08) }
    .section-title { font-weight:700; font-size:1.6rem }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/">HISTORIA</a>

    <ul class="navbar-nav">
      <li class="nav-item"><a class="nav-link" th:href="@{/}">Home</a></li>
      <li class="nav-item"><a class="nav-link" th:href="@{/situs}">Situs</a></li>
      <li class="nav-item"><a class="nav-link active" th:href="@{/lapor}">Lapor Situs Baru</a></li>
    </ul>

    <!-- Tampil untuk tamu (belum login) -->
    <a th:href="@{/login}" class="btn btn-primary btn-sm" sec:authorize="isAnonymous()">Login</a>

    <!-- Tampil HANYA untuk ADMIN (permintaanmu: jangan dihapus untuk admin) -->
    <a th:href="@{/login}" class="btn btn-primary btn-sm" sec:authorize="hasRole('ADMIN')">Login Admin</a>

    <!-- Disembunyikan untuk ROLE_USER (tidak ada tombol login admin) -->
    <div class="ms-3 d-flex align-items-center" sec:authorize="isAuthenticated()">
      <span class="text-muted small me-2">
        User:
        <strong
          th:text="${#strings.substringBefore((#authentication.principal instanceof T(org.springframework.security.oauth2.core.user.OAuth2User) ? #authentication.principal.attributes['email'] : #authentication.name),'@')}">
          username
        </strong>
      </span>
      <a th:href="@{/logout}" class="btn btn-outline-secondary btn-sm">Logout</a>
    </div>
  </div>
</nav>

<main class="container wrapper my-4">
  <div th:if="${pesanSukses}" class="alert alert-success" th:text="${pesanSukses}"></div>

  <div class="card p-4 p-md-5">
    <h3 class="text-center fw-bold mb-4">Formulir Lapor Situs Baru</h3>

    <form th:action="@{/lapor}" method="post" enctype="multipart/form-data">
      <h6 class="section-title mb-3">Informasi Situs</h6>

      <div class="mb-3">
        <label class="form-label">Nama Situs</label>
        <input name="namaSitus" class="form-control" required>
      </div>

      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">Pilih Provinsi</label>
          <select id="prov" class="form-select">
            <option value="">Pilih Provinsi</option>
            <option th:each="p : ${provinsiList}" th:value="${p.provinsiId}" th:text="${p.namaProvinsi}"></option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Pilih Kabupaten</label>
          <select id="kab" class="form-select" disabled>
            <option value="">Pilih Kabupaten</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Pilih Kecamatan</label>
          <select id="kec" class="form-select" disabled>
            <option value="">Pilih Kecamatan</option>
          </select>
        </div>
      </div>

      <!-- hidden yang dikirim -->
      <input type="hidden" name="provinsiId" id="provinsiId">
      <input type="hidden" name="kabupatenId" id="kabupatenId">
      <input type="hidden" name="kecamatanId" id="kecamatanId">

      <div class="mb-3 mt-3">
        <label class="form-label">Deskripsi Singkat dan Link Maps</label>
        <textarea name="deskripsiSingkat" class="form-control" rows="4" placeholder="Tulis ringkas + link Google Maps (opsional)"></textarea>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Tahun Ditemukan / Diperkirakan</label>
          <input name="tahunDitemukan" class="form-control" placeholder="Contoh: 1880 atau Abad ke-15">
        </div>

        <div class="col-md-6">
          <label class="form-label">Kondisi Saat Ini</label>
          <select name="kondisi" class="form-select">
            <option value="">-- Pilih Kondisi --</option>
            <option value="Sangat Baik">Sangat Baik</option>
            <option value="Baik">Baik</option>
            <option value="Cukup Baik">Cukup Baik</option>
            <option value="Tidak Baik">Tidak Baik</option>
            <option value="Sangat Tidak Baik">Sangat Tidak Baik</option>
          </select>
        </div>
      </div>

      <h6 class="section-title mt-4 mb-3">Informasi Pelapor</h6>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Nama Pelapor</label>
          <input name="namaPelapor" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Email</label>
          <input type="email" name="emailPelapor" class="form-control" required>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label class="form-label">Unggah Foto Situs</label>
          <input type="file" name="fotoFile" accept="image/*" class="form-control">
          <small class="text-muted">Boleh dikosongkan bila punya URL gambar di bawah.</small>
        </div>
        <div class="col-md-6">
          <label class="form-label">atau Foto URL</label>
          <input name="fotoUrl" class="form-control" placeholder="https:// ...">
        </div>
      </div>

      <div class="text-center mt-4">
        <button class="btn btn-primary px-4">Kirim Laporan</button>
      </div>
    </form>
  </div>
</main>

<script>
  const prov = document.getElementById('prov');
  const kab  = document.getElementById('kab');
  const kec  = document.getElementById('kec');
  const hidProv = document.getElementById('provinsiId');
  const hidKab  = document.getElementById('kabupatenId');
  const hidKec  = document.getElementById('kecamatanId');

  function reset(el, text){ el.innerHTML=''; el.append(new Option(text,'')); }

  async function jget(url){
    const r = await fetch(url, {headers:{'Accept':'application/json'}});
    if(!r.ok) return [];
    const ct = r.headers.get('content-type') || '';
    if(!ct.includes('application/json')) return [];
    return r.json();
  }

  prov.addEventListener('change', async () => {
    reset(kab,'Pilih Kabupaten'); reset(kec,'Pilih Kecamatan');
    hidProv.value = prov.value; hidKab.value = ''; hidKec.value='';
    kab.disabled = !prov.value; kec.disabled = true;
    if(!prov.value) return;

    const data = await jget(`/api/lokasi/kabupaten/${prov.value}`);
    data.forEach(k => kab.append(new Option(k.namaKabupaten, k.kabupatenId)));
  });

  kab.addEventListener('change', async () => {
    reset(kec,'Pilih Kecamatan'); hidKab.value = kab.value; hidKec.value='';
    kec.disabled = !kab.value; if(!kab.value) return;

    const data = await jget(`/api/lokasi/kecamatan/${kab.value}`);
    data.forEach(k => kec.append(new Option(k.namaKecamatan, k.kecamatanId)));
  });

  kec.addEventListener('change', () => { hidKec.value = kec.value; });
</script>
</body>
</html>
